<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF RAG Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <div class="container mx-auto px-4 py-8 flex-grow">
        <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden flex flex-col md:flex-row">
            <!-- Sidebar for PDF and Chat History -->
            <div class="w-full md:w-1/3 bg-gray-100 border-r p-4">
                <div class="mb-4">
                    <h2 class="text-xl font-bold mb-3">PDF Upload</h2>
                    <form id="uploadForm" class="mb-4" enctype="multipart/form-data">
                        <div class="flex">
                            <input 
                                type="file" 
                                id="pdfFile" 
                                accept=".pdf" 
                                class="flex-grow border p-2 rounded-l"
                            >
                            <button 
                                type="submit" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-r"
                            >
                                Upload
                            </button>
                        </div>
                    </form>
                    <div id="uploadStatus" class="mt-2 text-center"></div>
                </div>

                <!-- Chat History Section -->
                <div class="mt-4">
                    <h2 class="text-xl font-bold mb-3">Chat History</h2>
                    <div id="chatHistory" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Chat history items will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Main Chat Interface -->
            <div class="w-full md:w-2/3 flex flex-col">
                <!-- Chat Messages Area -->
                <div 
                    id="chatMessages" 
                    class="flex-grow p-4 overflow-y-auto bg-white"
                    style="max-height: 500px;"
                >
                    <div id="welcomeMessage" class="text-center text-gray-500 p-4">
                        <p class="mb-2">ðŸ‘‹ Welcome! Upload a PDF to start chatting.</p>
                        <p class="text-sm">Your PDF will be processed locally for Q&A.</p>
                    </div>
                </div>

                <!-- Context Display Area -->
                <div 
                    id="contextDisplay" 
                    class="bg-gray-50 p-2 max-h-32 overflow-y-auto text-sm"
                >
                    <p class="text-gray-500 text-center">Retrieved contexts will appear here</p>
                </div>

                <!-- Query Input Area -->
                <div class="p-4 border-t">
                    <form id="queryForm" class="flex">
                        <input 
                            type="text" 
                            id="queryInput" 
                            placeholder="Ask a question about your PDF..." 
                            class="flex-grow border p-2 rounded-l focus:outline-none focus:ring-2 focus:ring-blue-300"
                            autocomplete="off"
                        >
                        <button 
                            type="submit" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r transition-colors"
                            id="submitQuery"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            currentPDF: null,
            chatHistory: [],
            maxChatHistoryItems: 10
        };

        // DOM Elements
        const elements = {
            uploadForm: document.getElementById('uploadForm'),
            pdfFile: document.getElementById('pdfFile'),
            uploadStatus: document.getElementById('uploadStatus'),
            chatMessages: document.getElementById('chatMessages'),
            contextDisplay: document.getElementById('contextDisplay'),
            queryForm: document.getElementById('queryForm'),
            queryInput: document.getElementById('queryInput'),
            submitQuery: document.getElementById('submitQuery'),
            chatHistory: document.getElementById('chatHistory'),
            welcomeMessage: document.getElementById('welcomeMessage')
        };

        // Utility Functions
        function truncateText(text, maxLength = 50) {
            return text.length > maxLength 
                ? text.substring(0, maxLength) + '...' 
                : text;
        }

        function addToChatHistory(query) {
            // Add to chat history state
            state.chatHistory.unshift({
                query: truncateText(query),
                timestamp: new Date().toLocaleTimeString()
            });

            // Limit chat history
            if (state.chatHistory.length > state.maxChatHistoryItems) {
                state.chatHistory.pop();
            }

            // Render chat history
            elements.chatHistory.innerHTML = state.chatHistory.map(item => `
                <div class="bg-gray-200 p-2 rounded text-sm">
                    <p class="font-medium">${item.query}</p>
                    <p class="text-xs text-gray-600">${item.timestamp}</p>
                </div>
            `).join('');
        }

        function displayMessage(sender, message, type = 'normal') {
            // Remove welcome message if it exists
            if (elements.welcomeMessage) {
                elements.welcomeMessage.remove();
            }

            const messageClass = {
                normal: 'bg-white',
                user: 'bg-blue-100',
                ai: 'bg-green-100',
                error: 'bg-red-100'
            }[type];

            const messageIcon = {
                user: '<i class="fas fa-user mr-2"></i>',
                ai: '<i class="fas fa-robot mr-2"></i>',
                error: '<i class="fas fa-exclamation-triangle mr-2"></i>'
            }[sender];

            elements.chatMessages.innerHTML += `
                <div class="p-3 rounded my-2 ${messageClass} shadow-sm">
                    <div class="flex items-start">
                        ${messageIcon || ''}
                        <div class="flex-grow">
                            <strong class="block mb-1">${sender === 'user' ? 'You' : 'AI Assistant'}</strong>
                            ${message}
                        </div>
                    </div>
                </div>
            `;

            // Auto-scroll to bottom
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        function displayContexts(contexts) {
            if (!contexts || contexts.length === 0) {
                elements.contextDisplay.innerHTML = `
                    <p class="text-gray-500 text-center">No relevant contexts found</p>
                `;
                return;
            }

            elements.contextDisplay.innerHTML = contexts.map((context, index) => `
                <div class="bg-gray-100 p-2 rounded mb-1">
                    <p class="text-xs font-bold">Context ${index + 1} (Similarity: ${context.similarity_score.toFixed(4)})</p>
                    <p class="text-xs">${truncateText(context.text, 200)}</p>
                </div>
            `).join('');
        }

        // Event Listeners
        elements.uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = elements.pdfFile;
            const uploadStatus = elements.uploadStatus;
            
            if (!fileInput.files.length) {
                uploadStatus.innerHTML = '<p class="text-red-500">Please select a PDF file</p>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                uploadStatus.innerHTML = '<p class="text-blue-500">Uploading and processing...</p>';
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    state.currentPDF = result.filename;
                    uploadStatus.innerHTML = `
                        <p class="text-green-500">
                            <i class="fas fa-check-circle mr-2"></i>${result.message}
                        </p>
                    `;
                    
                    // Clear previous chat and welcome message
                    elements.chatMessages.innerHTML = '';
                    displayMessage('ai', 'PDF uploaded successfully! You can now ask questions about the document.');
                } else {
                    uploadStatus.innerHTML = `
                        <p class="text-red-500">
                            <i class="fas fa-times-circle mr-2"></i>${result.error}
                        </p>
                    `;
                }
            } catch (error) {
                uploadStatus.innerHTML = `
                    <p class="text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Error: ${error.message}
                    </p>
                `;
            }
        });

        elements.queryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const queryInput = elements.queryInput;
            const query = queryInput.value.trim();
            
            // Validate PDF upload and query
            if (!state.currentPDF) {
                displayMessage('ai', 'Please upload a PDF first.', 'error');
                return;
            }
            
            if (!query) return;
            
            // Disable submit during processing
            elements.submitQuery.disabled = true;
            elements.submitQuery.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Display user message
            displayMessage('user', query);
            
            // Add to chat history
            addToChatHistory(query);
            
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Display AI response
                    displayMessage('ai', result.response);
                    
                    // Display retrieved contexts
                    displayContexts(result.contexts);
                } else {
                    displayMessage('ai', result.error, 'error');
                }
                
                // Clear input
                queryInput.value = '';
            } catch (error) {
                displayMessage('ai', `Network error: ${error.message}`, 'error');
            } finally {
                // Re-enable submit
                elements.submitQuery.disabled = false;
                elements.submitQuery.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        });
    </script>
</body>
</html>